# vim:syntax=zsh
# vim:filetype=zsh

#
# interactive env
#

# load junegunn/fzf if installed
if [ -f ~/.fzf.zsh ]; then
  source ~/.fzf.zsh
  export FZF_DEFAULT_OPTS='--height 40% --layout=reverse'
  # if fd is present, make fzf use that
  if [ ! -z "$(command -v fd)" ]; then
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude={.git,.idea,.sass-cache,node_modules,build,.rustup,.cache}'
  elif [ ! -z "$(command -v fdfind)"  ]; then
    export FZF_DEFAULT_COMMAND='fdfind --type f --hidden --follow --exclude={.git,.idea,.sass-cache,node_modules,build,.rustup,.cache}'
  fi
fi

# GPG for SSH authentication
# do it only if there's TTY
# -- look for macOS
if [[ $(command -v TTY) ]] && [[ "$(uname -s)" == 'Darwin' ]]; then
export "GPG_TTY=$(TTY)"
export "SSH_AUTH_SOCK=${HOME}/.gnupg/S.gpg-agent.ssh"
# notes:
#   for command line tty, ~/.gnupg/gpg-agent.conf needs:
#       pinentry-program /usr/bin/pinentry-curses
#   if needed, run the command below to force telling the agent which tty to use
#     gpg-connect-agent updatestartuptty /bye
fi
# -- look for Linux (excluding WSL which needs socat and a different config)
if [[ $(command -v tty) ]] && [[ "$(uname -s)" == 'Linux' ]] && [[ -z "$(uname -a | grep -i wsl)" ]]; then
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
gpgconf --launch gpg-agent
fi

# Scaleway CLI autocomplete initialization.
if [[ $(command -v scw) ]]; then
  eval "$(scw autocomplete script shell=zsh)"
fi

# Secure ShellFish iOS app integration
if [[ -f "$HOME/.shellfishrc" ]]; then
  source $HOME/.shellfishrc
fi

# krew
if [ -d "${KREW_ROOT:-$HOME/.krew}/bin" ]; then
  export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
fi

# fasd to jump around
if [ $(command -v fasd) ]; then
  eval "$(fasd --init auto)"
fi

#
# common aliases
#

# config
alias zshconfig="vim ~/.zshrc"
alias omzconfig="vim ~/.oh-my-zsh"
alias sshconfig="vim ~/.ssh/config"
alias mmv='noglob zmv -W'
alias history='history 1'

# system
alias nv='nvim'
alias l='ls -lhA'
alias lr='ll -RA'
alias lt='ll -t'
alias gdb='nocorrect gdb'
alias wgetnc="wget --no-check-certificate"
alias dk="docker"
alias sshnosave="ssh -o 'UserKnownHostsFile /dev/null'"
alias sshforget='ssh-keygen -R'
alias grep="grep -i"

# git
alias gg='git grep -i'
alias gitc='git-crypt'

# tmux
alias main='tmux attach -t main || tmux new -s main'
alias work='tmux attach -t work || tmux new -s work'
alias tm_kill='tmux kill-session -t'
alias tm_kill_unnamed="tmux ls | grep -E '^[0-9]' | cut -d':' -f1 | xargs -I {} tmux kill-session -t {}"

# if you need to jump on many hosts and don't want to setup tons of entries in .ssh/config:
#alias sshvm='ssh -o ProxyCommand="ssh -l francesco -W %h:%p jumphost.somedomain.com"'

#
# utilities
#

alias diceroller='shuf -i 1-6 -n 1'
alias randompin='shuf -i 100000-999999 -n 1'
alias randompass="shuf -n6 /usr/share/dict/words | sed 's/$/-/g' | tr -d '\n' | cut -d'-' -f1-6"

if [ -f /etc/debian_version ]; then
  alias fd=fdfind
fi

# exa
if [ "$(command -v exa)" ]; then
  alias lsx='exa -G -x --color auto --icons -s type'
  alias llx='exa -l --color auto --icons -s type --git'
  alias lax='llx -a'
  alias lx='lax'
  alias ltx='llx -a -snew'
fi

# on Ubuntu the pkg is called 'batcat'
if [ "$(command -v batcat)" ]; then alias bat='batcat'; fi
# bat (cat(1) clone with wings)
if [ "$(command -v bat)" ]; then
  export BAT_STYLE="changes,header,numbers,snip"
  unalias -m 'cat'
  alias cat='bat -p'
fi

alias epoch='date +%s'

# print ip and location info
alias myip='curl ipinfo.io/json'

# print fat folders
alias ducks='du -cksh $(ls -A) | sort -hr | head -n 15'

# self made dos2unix if original one does not exist
if [[ -z $(command -v dos2unix) ]]; then
alias dos2unix="sed -i 's/\r$//'"

# all CRLF to LF in one shot (binary files will be automatically skipped)
alias all2unix="find . -type f -exec dos2unix {} \;"
fi

# python
alias py='python'
alias py2='python2'
alias py3='python3'
alias pyc='python -m compileall'
alias pyc2='python2 -m compileall'
alias pyc3='python3 -m compileall'
alias serve='python3 -m http.server'
alias pip='python -m pip'
alias pip2='python2 -m pip'
alias pip3='python3 -m pip'

# node.js
alias npmlist='npm list --depth=0'
alias npmlistg='npm list -g --depth=0'

# k8s
alias k='kubectl'

# jekyll
alias jk='jekyll'
alias jkk='$HOME/dotfiles/bin/check_jk_running.sh'

# other
alias ydl='youtube-dl'
alias lg='lazygit'
alias ldk='lazydocker'
alias kittyupdate='curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin'

# pgadmin
if [[ -z $(command -v pgadmin) ]]; then
  alias pgadmin="docker run -d --net=host --name pgadmin -e PGADMIN_DEFAULT_EMAIL='email@email.com' -e PGADMIN_DEFAULT_PASSWORD=password -e PGADMIN_LISTEN_PORT=54321 dpage/pgadmin4"
fi

#
# Linux-only aliases
#
if [[ "$(uname -s)" == 'Linux' ]]; then
  alias xclip="xclip -selection c"
  alias open='xdg-open'

  # custom sublime text habits are hard to die...
  if [[ $(command -v subl) ]]; then
    alias st=subl
  fi
fi

#
# macOS-only aliases
#
if [[ "$(uname -s)" == 'Darwin' ]]; then
alias st='open -a Sublime\ Text'
alias vscode='open -a Visual\ Studio\ Code'
alias fork='open -a /Applications/Fork.app'
alias listen='lsof -iTCP -sTCP:LISTEN -n -P'
fi
