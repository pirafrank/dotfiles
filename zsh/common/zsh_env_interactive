# vim:syntax=zsh
# vim:filetype=zsh

# dotfiles/zsh/common/zsh_env is always sourced because
# it's loaded by dotfiles/zsh/zprezto/runcoms/zshenv.
# This file is for interactive env, only to be loaded in .zshrc.

#
# interactive env
#

# load junegunn/fzf if installed
if [ -f ~/.fzf.zsh ]; then
  source ~/.fzf.zsh
  export FZF_DEFAULT_OPTS='--layout=reverse'
  # if fd is present, make fzf use that
  if [ ! -z "$(command -v fdfind)" ]; then
    export FZF_DEFAULT_COMMAND='fdfind --type f --hidden --follow --exclude={.git,.idea,.sass-cache,node_modules,build,.rustup,.cache}'
  elif [ ! -z "$(command -v fd)"  ]; then
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude={.git,.idea,.sass-cache,node_modules,build,.rustup,.cache}'
  fi

  # config fzf preview alias
  if [ "$(command -v batcat)" ]; then
    alias fp="fzf --preview 'batcat --style=numbers --color=always --line-range :500 {}'"
  elif [ "$(command -v bat)" ]; then
    alias fp="fzf --preview 'bat --style=numbers --color=always --line-range :500 {}'"
  fi
fi

# GPG for SSH authentication
# do it only if there's TTY
# -- look for macOS
if [[ $(command -v TTY) ]] && [[ "$(uname -s)" == 'Darwin' ]]; then
export "GPG_TTY=$(TTY)"
export "SSH_AUTH_SOCK=${HOME}/.gnupg/S.gpg-agent.ssh"
# notes:
#   for command line tty, ~/.gnupg/gpg-agent.conf needs:
#       pinentry-program /usr/bin/pinentry-curses
#   if needed, run the command below to force telling the agent which tty to use
#     gpg-connect-agent updatestartuptty /bye
fi
# -- look for Linux (excluding WSL which needs socat and a different config)
if [[ $(command -v tty) ]] && [[ "$(uname -s)" == 'Linux' ]] && [[ -z "$(uname -a | grep -i wsl)" ]]; then
export GPG_TTY=$TTY
export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
gpgconf --launch gpg-agent
fi

# fasd to jump around
if [ $(command -v fasd) ]; then
  eval "$(fasd --init auto)"
fi

# Secure ShellFish iOS app integration
if [[ -f "$HOME/.shellfishrc" ]]; then
  source $HOME/.shellfishrc
fi

# Added by serverless binary installer
if [ -d "$HOME/.serverless/bin" ]; then
  export PATH="$HOME/.serverless/bin:$PATH"
fi
